name: Daily Reddit Bot (Debuggable)

# triggers: scheduled + manual dispatch (for testing)
on:
  schedule:
    - cron: '0 1 * * *'   # 09:00 Asia/Shanghai == 01:00 UTC (adjust if needed)
  workflow_dispatch:

concurrency:
  group: daily-reddit-bot
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      # Non-sensitive defaults - these will be overwritten by Secrets when run in Actions
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      CHAT_ID: ${{ secrets.CHAT_ID }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show repo files (debug)
        run: |
          echo "=== ls -la ==="
          ls -la
          echo "=== tree (first 4 levels) ==="
          if command -v tree >/dev/null 2>&1; then tree -L 4 || true; else find . -maxdepth 3 -print; fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Print Python & pip versions
        run: |
          python -V
          pip -V
          python -m site

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install --no-cache-dir -r requirements.txt; else echo "No requirements.txt present"; fi

      - name: Show important files (debug)
        run: |
          echo "=== main.py head ==="
          sed -n '1,200p' main.py || true
          echo "=== reddit_fetcher.py head ==="
          sed -n '1,200p' reddit_fetcher.py || true

      - name: Print environment summary (not secrets)
        run: |
          echo "== Environment summary =="
          echo "GITHUB_REPOSITORY=$GITHUB_REPOSITORY"
          echo "GITHUB_REF=$GITHUB_REF"
          echo "WORKFLOW run by $GITHUB_ACTOR"
          echo "TELEGRAM_BOT_TOKEN set? -> $(if [ -z \"$TELEGRAM_BOT_TOKEN\" ]; then echo 'NO'; else echo 'YES'; fi)"
          echo "CHAT_ID set? -> $(if [ -z \"$CHAT_ID\" ]; then echo 'NO'; else echo 'YES'; fi)"
          echo "GEMINI_API_KEY set? -> $(if [ -z \"$GEMINI_API_KEY\" ]; then echo 'NO'; else echo 'YES'; fi)"

      - name: Run bot (debug wrapper)
        # Use a wrapper that prints debug info and runs main.py with verbose logging
        run: |
          chmod +x run_bot.sh || true
          ./run_bot.sh
        # No secrets in the workflow file; they come from repo secrets automatically

      - name: Upload logs (optional)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: reddit-telegram-bot-logs
          path: ./bot_debug.log
